name: Databricks Bundle Deployment & Test

on:
  push:
    branches:
      - main
    paths:
      - 'sbit_medallion_pipeline/src/**'
      - 'sbit_medallion_pipeline/tests/**'
      - 'sbit_medallion_pipeline/resources/**'
      - 'sbit_medallion_pipeline/databricks.yml'

jobs:
  deploy_and_test:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./sbit_medallion_pipeline

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      # --- 关键：验证当前身份，确保不会连错 Org ---
      - name: Check Auth Identity
        run: databricks auth describe
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

      # --- 第一步：验证 Bundle (增加 --profile 强制隔离环境) ---
      - name: Validate Bundle
        run: databricks bundle validate -t dev
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

      # --- 第二步：部署 Bundle ---
      - name: Deploy Bundle to Dev
        run: databricks bundle deploy -t dev
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

      # --- 第三步：运行集成测试 ---
      - name: Run Integration Test
        run: |
          echo "开始执行集成测试..."
          databricks bundle run sbit_integration_test_job -t dev
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

      - name: Success Notice
        if: success()
        run: echo "部署与集成测试圆满完成！"