name: "Terraform Build & Deploy"

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  id-token: write

jobs:
  terraform_and_deploy:
    name: "Terraform & Deploy"
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      # Databricks 认证变量
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # --- 1. Terraform 基础架构管理 ---
      # 现在只负责资源组、存储、ADF、Databricks 等，不碰 Function
      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false

      # --- 2. 完善 Databricks 设置 ---
      # 虽然不部署 Function，但 Databricks 的代码同步我们保留并完善
      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-databricks/main/install.sh | sh

      - name: Sync Notebooks to Databricks
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          # 自动将仓库里的 notebooks 文件夹同步到 Databricks
          # 确保环境变量 DATABRICKS_HOST 和 DATABRICKS_TOKEN 已在 GitHub Secrets 配置
          databricks workspace import_dir ./notebooks /Shared/SBIT_Data_Engineering --overwrite

      # --- 部署结束 ---
      # 已移除所有关于 SBIT-bmp, SBIT-user-info, SBIT-workout 的打包和部署步骤